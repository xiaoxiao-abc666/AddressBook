<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>极限编程通讯录 (Team Project)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .star-icon { cursor: pointer; color: #ccc; transition: color 0.2s; }
        .star-icon.active { color: #ffc107; } /* 金色星星 */
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-address-book text-primary"></i> 团队通讯录</h2>
        <div>
            <a href="/export" class="btn btn-success me-2">
                <i class="fas fa-file-excel"></i> 导出 Excel
            </a>
            <button class="btn btn-info text-white" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-file-import"></i> 导入 Excel
            </button>
            <input type="file" id="fileInput" hidden onchange="importExcel(this)">
            
            <button class="btn btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#addModal">
                <i class="fas fa-plus"></i> 新增联系人
            </button>
        </div>
    </div>

    <div class="mb-3">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="favFilter" onchange="loadContacts()">
            <label class="form-check-label" for="favFilter">只看收藏 (Favorites)</label>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th width="50">收藏</th>
                        <th width="20%">姓名</th>
                        <th>联系方式 (Phone/Email...)</th>
                        <th width="100">操作</th>
                    </tr>
                </thead>
                <tbody id="contactList">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新增联系人</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">姓名</label>
                    <input type="text" class="form-control" id="inputName">
                </div>
                <label class="form-label">联系方式</label>
                <div id="methodsContainer">
                    <div class="input-group mb-2">
                        <select class="form-select" style="max-width: 100px;">
                            <option value="phone">电话</option>
                            <option value="email">邮箱</option>
                            <option value="wechat">微信</option>
                        </select>
                        <input type="text" class="form-control" placeholder="输入号码/地址">
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-secondary" onclick="addMethodField()">+ 添加更多方式</button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveContact()">保存</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = 'http://127.0.0.1:5000'; // 确保这里是你后端的地址

    // 1. 页面加载完成后，获取数据
    document.addEventListener('DOMContentLoaded', () => {
        loadContacts();
    });

    // 2. 获取并渲染联系人列表
    async function loadContacts() {
        const onlyFav = document.getElementById('favFilter').checked;
        const url = onlyFav ? `${API_URL}/contacts?favorite=true` : `${API_URL}/contacts`;
        
        try {
            const res = await fetch(url);
            const contacts = await res.json();
            const tbody = document.getElementById('contactList');
            tbody.innerHTML = ''; // 清空列表

            contacts.forEach(c => {
                // 处理多联系方式显示
                let methodsHtml = c.methods.map(m => 
                    `<span class="badge bg-secondary me-1">${m.type}: ${m.value}</span>`
                ).join('');

                const row = `
                    <tr>
                        <td>
                            <i class="fas fa-star star-icon ${c.is_favorite ? 'active' : ''}" 
                               onclick="toggleFavorite(${c.id})"></i>
                        </td>
                        <td class="fw-bold">${c.name}</td>
                        <td>${methodsHtml}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteContact(${c.id})">删除</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        } catch (err) {
            console.error(err);
            alert('加载失败，请检查后端是否运行');
        }
    }

    // 3. 收藏功能
    async function toggleFavorite(id) {
        await fetch(`${API_URL}/contacts/${id}/favorite`, { method: 'PUT' });
        loadContacts(); // 刷新列表
    }

    // 4. 删除功能
    async function deleteContact(id) {
        if(confirm('确定删除吗？')) {
            await fetch(`${API_URL}/contacts/${id}`, { method: 'DELETE' });
            loadContacts();
        }
    }

    // 5. 新增联系人：动态添加输入框
    function addMethodField() {
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = `
            <select class="form-select" style="max-width: 100px;">
                <option value="phone">电话</option>
                <option value="email">邮箱</option>
                <option value="wechat">微信</option>
            </select>
            <input type="text" class="form-control" placeholder="输入号码/地址">
            <button class="btn btn-outline-danger" onclick="this.parentElement.remove()">x</button>
        `;
        document.getElementById('methodsContainer').appendChild(div);
    }

    // 6. 保存联系人
    async function saveContact() {
        const name = document.getElementById('inputName').value;
        if (!name) return alert('请输入姓名');

        // 收集所有的联系方式
        const methods = [];
        const container = document.getElementById('methodsContainer');
        const groups = container.getElementsByClassName('input-group');
        
        for (let g of groups) {
            const type = g.querySelector('select').value;
            const value = g.querySelector('input').value;
            if (value) methods.push({ type, value });
        }

        await fetch(`${API_URL}/contacts`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, methods })
        });

        // 关闭弹窗并刷新
        const modal = bootstrap.Modal.getInstance(document.getElementById('addModal'));
        modal.hide();
        document.getElementById('inputName').value = ''; // 清空输入
        loadContacts();
    }

    // 7. 导入 Excel
    async function importExcel(input) {
        const file = input.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        try {
            const res = await fetch(`${API_URL}/import`, {
                method: 'POST',
                body: formData
            });
            if (res.ok) {
                alert('导入成功！');
                loadContacts();
            } else {
                alert('导入失败，请检查文件格式');
            }
        } catch (e) {
            alert('上传出错');
        }
        input.value = ''; // 重置文件框
    }
</script>
</body>
</html>